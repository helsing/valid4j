
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2014-12-08
 Rendered using Reflow Maven Skin 1.1.0 (http://andriusvelykis.github.io/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>valid4j</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.3.2/spacelab/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="./css/bootswatch.css" rel="stylesheet" />
		<link href="./css/reflow-skin.css" rel="stylesheet" />

		
		<link href="./css/lightbox.css" rel="stylesheet" />
		
		<link href="./css/site.css" rel="stylesheet" />
		<link href="./css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->



	</head>

	<body class="page-concepts project-valid4j" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="http://helsing.github.io/valid4j/">valid4j</a>
					<div class="nav-collapse collapse" id="top-nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Menu <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="index.html" title="Overview">Overview</a></li>
									<li class="active"><a href="" title="Concepts">Concepts</a></li>
									<li ><a href="apidocs/index.html" title="JavaDoc">JavaDoc</a></li>
									<li ><a href="faq.html" title="FAQ">FAQ</a></li>
									<li ><a href="https://github.com/helsing/valid4j" title="GitHub" class="externalLink">GitHub</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li class="dropdown-submenu ">
										<a href="project-info.html" title="Project Information">Project Information</a>
										<ul class="dropdown-menu">
											<li ><a href="index.html" title="About">About</a></li>
											<li ><a href="plugin-management.html" title="Plugin Management">Plugin Management</a></li>
											<li ><a href="distribution-management.html" title="Distribution Management">Distribution Management</a></li>
											<li ><a href="dependency-info.html" title="Dependency Information">Dependency Information</a></li>
											<li ><a href="source-repository.html" title="Source Repository">Source Repository</a></li>
											<li ><a href="mail-lists.html" title="Mailing Lists">Mailing Lists</a></li>
											<li ><a href="issue-tracking.html" title="Issue Tracking">Issue Tracking</a></li>
											<li ><a href="integration.html" title="Continuous Integration">Continuous Integration</a></li>
											<li ><a href="plugins.html" title="Project Plugins">Project Plugins</a></li>
											<li ><a href="license.html" title="Project License">Project License</a></li>
											<li ><a href="team-list.html" title="Project Team">Project Team</a></li>
											<li ><a href="project-summary.html" title="Project Summary">Project Summary</a></li>
											<li ><a href="dependencies.html" title="Dependencies">Dependencies</a></li>
										</ul>
									</li>
									<li class="dropdown-submenu ">
										<a href="project-reports.html" title="Project Reports">Project Reports</a>
										<ul class="dropdown-menu">
											<li ><a href="apidocs/index.html" title="JavaDocs">JavaDocs</a></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->

	<header>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span8">
			<div class="body-content">
<div class="page-header">
 <h1 id="in-depth">In-depth</h1>
</div> 
<h1 id="concepts">Concepts</h1> 
<p>Programming by contract is a simple, yet powerful, technique to achieve assertive programming. The basic idea of valid4j is to make a clear distinction between <i>programming errors</i> and <i>recoverable exceptions</i>. Programming errors are not recoverable exceptions and should not be handled as such.</p> 
<div class="section"> 
 <div class="section"> 
  <h3 id="Programming_errors">Programming errors</h3> 
  <p>Programming errors are usually the result of an oversight of assumptions that really doesn’t hold. This may result in logical contradictions, like trying to use a non-existent object (e.g. <tt>NullPointerException</tt>) or invoking a method with an incomprehensible argument (e.g. <tt>IllegalArgumentException</tt>).</p> 
  <p>Logical errors must be corrected at design time. It doesn’t make sense to <tt>try</tt> illogical invocations in order to <tt>catch</tt> and recover from them. But we still want our programs to detect, expose and locate these bugs. Programming by contract gives us a technique to do just that.</p> 
 </div> 
 <div class="section"> 
  <h3 id="Recoverable_exceptions">Recoverable exceptions</h3> 
  <p>Recoverable exceptions, on the other hand, signal exceptional cases that a correct program can and should handle gracefully. This might be network connection errors, file system errors or data input validation errors. This is what we in everyday talk refer to as error handling, fault tolerance and the like.</p> 
  <p>According to the Java exception hierarchy, as a general rule programming errors should inherit from <tt>RuntimeException</tt> whereas <tt>Error</tt> is reserved for internal errors of the Java runtime system. However, there is also differing opinions regarding the proper use of checked vs unchecked exceptions. This has led to the widespread use of <tt>RuntimeException</tt> also for recoverable exceptions.</p> 
  <p>Valid4J prefers to use <tt>Error</tt> to signal programming errors, and is agnostic to the question of using checked or unchecked recoverable exceptions.</p> 
  <h1 id="defensive_programming_dont_do_it">Defensive programming, don’t do it</h1> 
  <p>…a common, but sad example… </p> 
  <div class="source"> 
   <pre>// Example of client code with sad defensive programming
Object someParam;
...
Stuff result = supplier.method(someParam);
if (result == null) {
  // Some error handling
} else if (supplier.getState() == GREAT) {
  result.doWork();
} else {
  // Some more error handling
}


// Example of supplier code with sad defensive programming
public Stuff method(Object param) {
  Stuff r;
  if (param == null) {
    // Some error handling
  } else if (getState() == GOOD) {
    r = a.doStuff();
  } else {
    // Even more error handling
  }
  return r;
</pre> 
  </div> 
  <p>The characteristic of the above code is that no one knows their responsibilities. No one knows what they are supposed to do or what others are supposed to do. Code is recognized by “maybe”/“perhaps”/“if you’re lucky” statements, obscuring the real semantics and valid error handling. Are there any programming errors hidden in this code? How do I know? Defensive programming hides programming errors in a bloat of code and - which is worse - are handled as ordinary recoverable errors! Programming errors should not be dealt with this way. Fail fast and don’t let programming errors go undetected.</p> 
  <hr /> 
  <h1 id="programming_by_contracts">Programming by contracts</h1> 
  <p>The principle of design by contract is to clarify the responsibilities of the calling side (client) and the corresponding responsibilities of the called side (supplier). Delegating responsibilities is key to all good design. We do this by specifying which conditions must be met by the client, and which conditions must be met by the supplier.</p> 
  <p><img src="images/handshake.jpg" alt="The agreement" /></p> 
  <p>A violation of the precondition means that the client has not fulfilled the contract, hence there is a programming error on the client side. The client is <i>required</i> to make sure the preconditions hold before calling a method.</p> 
  <p>A violation of the postcondition means that the supplier has not fulfilled the contract, hence there is a programming error on the supplier side. The supplier <i>ensures</i> that the postcondition holds before returning from a method.</p> 
  <p>By using the mechanism of contracts, bugs in the software are instantly exposed as soon as they are detected in runtime. A contract violation means that an assumption in the software doesn’t hold. This means we are executing in an unknown state. </p> 
  <p>Never try to catch and recover from a contract violation. A bug-free application should not rely on contracts being evaluated at all. A reasonable approach would be to abort the application, possibly followed with some kind of global recovery, like restarting the application, returning a HTTP 500 response or similar. </p> 
 </div> 
 <div class="section"> 
  <h3 id="Require_contracts_preconditions">Require contracts (preconditions)</h3> 
  <ul> 
   <li>The clients’ responsibility. What the client is <i>required</i> to fulfill.</li> 
   <li>Expresses what has to be fulfilled before a method may be called.</li> 
   <li>Expressed as condition(s) on the state of the supplier, and/or input parameters.</li> 
  </ul> 
 </div> 
 <div class="section"> 
  <h3 id="Ensure_contracts_postconditions">Ensure contracts (postconditions)</h3> 
  <ul> 
   <li>The suppliers’ responsibility. What the supplier <i>ensures</i> will be fulfilled.</li> 
   <li>Expresses what is fulfilled after the method has executed.</li> 
   <li>Expressed as condition(s) on the state of the supplier, and/or return values.</li> 
   <li>Recoverable exception(s) may be thrown in those cases where the method can not fulfill its postcondition(s). (This is error handling, not contracts…)</li> 
  </ul> 
 </div> 
 <div class="section"> 
  <h3 id="Invariants">Invariants</h3> 
  <ul> 
   <li>Expresses what is always fulfilled for an object.</li> 
   <li><b>Important</b>: Must hold <i>even if</i> a recoverable exception is thrown!</li> 
   <li>This is trickier than it seems… Be careful - dragons be here!</li> 
  </ul> 
  <p>Prefer immutable classes and check invariants at exit of constructor. This is a much simpler special case of invariants.</p> 
  <hr /> 
  <h1 id="assertive_programming">Assertive programming</h1> 
  <p>Using contracts it’s easy to see what assumptions we can rely on and which conditions we are to achieve. The readability of the code is improved. Any if-else statements or try-catch clauses deal with proper error handling and fault tolerance, not programming errors. Code to the point!</p> 
  <p>Contractual assumptions are evaluated at runtime and any violations will immediately be detected, exposed and located which greatly speeds up and simplifies bug fixing. Slow, boring and tedious debugging is not needed any more.</p> 
  <div class="source"> 
   <pre>// Example of assertive client code
Stuff result = supplier.method(someParam);
result.doWork();

// Example of assertive supplier code
public Stuff method(Object param) {
  require(param, notNullValue());
  require(getState(), equalTo(GOOD));
  ...
  ensure(getState(), equalTo(GREAT));
  return ensure(r, notNullValue());
}
</pre> 
  </div> 
  <p>Beneficial side effects of using contracts is that it</p> 
  <ul> 
   <li>encourages the use of a single exit/return statement where the ensure contract may be checked. Several return statements, each checking the postcondition, would clutter the code and be error prone.</li> 
   <li>makes it obvious for the programmer to reason about what recoverable exceptions could occur when executing the code, i.e. the cases when the ensure contracts cannot be fulfilled.</li> 
  </ul> 
  <hr /> 
  <h1 id="good_manners_to_keep">Good manners to keep</h1> 
  <p>Easy! Right? If we are using contracts to clarify the responsibilities between clients and suppliers there are a couple of things to keep in mind. </p> 
 </div> 
 <div class="section"> 
  <h3 id="Separate_queries_from_commands">Separate queries from commands</h3> 
  <p>There are two types of methods in the world:</p> 
  <ul> 
   <li>Commands/mutators - methods that change the program state in any way.</li> 
   <li>Queries/accessors - methods that do not change the program state. These are side-effect free functions.</li> 
  </ul> 
  <p>We should separate commands from queries. Our methods should have a single well-defined responsibility. Either they are commands, methods that change the current state of our program. Or they are queries, side-effect free methods that just return a result. Evaluating and verifying contracts shall not change the (perceived) program state. (Perceived that is; like acquiring &amp; releasing a mutex may be ok, caching may be ok.)</p> 
  <p>Why? Goes without saying! Contracts are a part of the specification, not the semantics. The outcome of a contract check must not depend on how many times it has been checked (if any). A bug-free application should not rely on contracts being evaluated at all.</p> 
  <p>Only use queries in contract evaluations. Never use commands in contract evaluations.</p> 
 </div> 
 <div class="section"> 
  <h3 id="Provide_a_complete_and_usable_interface_for_clients">Provide a complete (and usable) interface for clients</h3> 
  <p>Specifying preconditions is the same as putting requirements on our clients. We are essentially demanding them to fulfill their responsibilities. Make sure they also have the <i>possibility</i> to achieve that.</p> 
  <div class="source"> 
   <pre>public class BadManners {
  public BadManners(int i) {
    require(isValid(i)); // Never use private methods in contracts!!
                         // ...makes the class pretty useless
  }
  private static boolean isValid(int i) { ... }
}
</pre> 
  </div> 
  <p>When specifying contracts, provide clients with a public interface to make it possible for them to fulfill their obligations. Using private methods as a contract specification makes the class pretty useless. No client can fulfill their responsibilities if it’s not possible for them to check if they actually <i>have</i> fulfilled them.</p> 
  <h1 id="contracts_vs_error_handling">Contracts vs. error handling</h1> 
  <p>Contracts is not error handling! Error handling is not contracts!</p> 
  <p>Use contracts to ensure the correctness of a program. Contracts are used to detect logical errors or internal contradictions, making sure that the collaborating classes that constitute the program fulfill their obligations. Do not use contracts to deal with situations that couldn’t be considered to be in our control, like invalid user input, network connection errors, or file system issues. Contracts are no substitute for proper error handling and recovery.</p> 
  <p><img src="images/contracts-and-validation.png" alt="Contracts is not validation" /></p> 
  <p>Use error handling to ensure the robustness of a program. To deal with exceptional cases outside our control, like erroneous user input or failed network connections, we need error handling. Do not use error handling to deal with logical errors, i.e. programming errors.</p> 
  <div class="source"> 
   <pre>// Example of using contracts when creating new instances of Country
public class Country {

  // Use contract to specify that it is the _clients_ responsibility
  // to make sure only valid country codes are given to the constructor.
  // Invoking this constructor with an invalid country code is considered
  // to be a programming error on the clients part.
  public Country(String code) {
    require(isValidCountryCode(code));
    // 
  }

  // Make method available (i.e public) for clients to use, making it possible
  // for them to fulfill their part of the contract
  public static boolean isValidCountryCode(String code) {
    // ...
  }
}
</pre> 
  </div> 
  <p>The above code is an example on how to use contracts to push a responsibility to the client. A client which doesn’t fulfill the contract has a programming error.</p> 
  <p>Below is the same code using a technique of error handling instead.</p> 
  <div class="source"> 
   <pre>// Example of using error handling when creating new instances of Country
public static class Country {

  // Define a recoverable exception for clients to catch and recover from
  public static class InvalidCountryCodeException extends RuntimeException {}

  // Use error handling to throw a recoverable exception in the case an
  // invalid country code is supplied to the constructor. A proper client 
  // will have to catch and recover from such an exception should it occur.
  public Country(String code) {
    validate(isValidCountryCode(code), new InvalidCountryCodeException());

  }

  // Validation code may or may not be available for clients to use directly.
  private static boolean isValidCountryCode(String code) {
    // ...
  }
}
</pre> 
  </div> 
  <p>How do we choose between using contracts and/or error handling? As a designer of a class we can decide how much responsibility we can and will put on our clients. What is the anticipated usage of the class? Is it possible to require clients to fulfill certain tasks? </p> 
  <p>A guideline to bear in mind is that in a bug-free application, the contract checking should be possible to switch off. (<i>Possible</i> that is; we are not recommending to switch them off, though, nota bene.) Proper error handling can not be switched off since there will be clients that rely on recoverable exceptions being thrown when exceptional conditions occur.</p> 
  <p>Also remember that (recoverable) exceptions should be used for exceptional cases, not the normal flow in a program.</p> 
  <h1 id="contracts_and_inheritance">Contracts and inheritance</h1> 
  <p>When using contracts in inherited classes, remember the <a class="externalLink" href="http://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov Substititution Principle (LSP)</a>. It states that, if S is a subtype of T, then objects of type T may be replaced with objects of type S. Think, S is-a T.</p> 
  <p><img src="images/contracts-and-lsp.png" alt="Contracts and inheritance" /></p> 
  <p>In regards to contracts this means that a subclass must not require more from its client, than the base class. And a subclass must not ensure less to its client, than the base class.</p> 
  <p>Therefore:</p> 
  <ul> 
   <li>Subclasses may have the same or weaker preconditions (as the base class), but not stronger.</li> 
   <li>Subclasses may have the same or stronger postconditions (as the base class), but not weaker.</li> 
  </ul> 
  <h1 id="contracts_and_multi-threading">Contracts and multi-threading</h1> 
  <p>The first rule of multi-threading: avoid shared mutable state!</p> 
  <p>That being said, if we want to use contracts on shared mutable objects, we can’t put preconditions on the current supplier <i>state</i>. This is because, in a multi-threaded environment there is no way for a client to make sure that such a condition holds before making the call (effectively making the class pretty useless).</p> 
  <p><img src="images/contracts-and-multi-threading.png" alt="Contracts and multi-threading" /></p> 
  <p>One option would be to throw a (recoverable) exception if the condition is not satisfied. In such an event the client could just catch and recover from the failure.</p> 
  <div class="source"> 
   <pre>// Example of throwing a recoverable exception
validate(myState == GOOD_STATE, new InvalidStateException());
</pre> 
  </div> 
  <p>Another option would be to require the client to acquire exclusive access to the object prior to any invocations. If so, put contract on this!</p> 
  <div class="source"> 
   <pre>// Example of precondition to acquire exclusive access before invocation
require(Thread.holdsLock(this));
require(myState == GOOD_STATE);
</pre> 
  </div> 
  <p>Preconditions on input <i>arguments</i> is the same in a multi-threaded environment as in a single-threaded environment (assuming they themselves aren’t modified by multiple threads…).</p> 
  <h1 id="contracts_and_unit_testing">Contracts and unit testing</h1> 
  <p>Contracts and unit testing complement each other. </p> 
  <p>Contracts capture the general semantic of a method, e.g. addition: result == a+b, whereas unit tests verify a specific execution path, e.g. scenario: 3 == 1+2.</p> 
  <p>Contracts are written into the production code, whereas unit tests give an example of proper usage in non-production code.</p> 
  <p>Contracts are enforced during unreliable live execution, whereas unit tests exercise the code in a safe test environment. So, make sure to leave the contracts switched on, even in production.</p> 
  <p>Contracts specify the space of allowed invocations of a method, by specifying which conditions must be satisfied prior to invocation. This knowledge may be used to exclude the “out-of-specification” space from what is unit tested, making the testing effort concentrate on the space in-specification.</p> 
  <hr /> 
  <h1 id="references">References</h1> 
  <ul> 
   <li><a class="externalLink" href="https://en.wikipedia.org/wiki/Design_by_Contract">Wikipedia, Design by Contract</a>.</li> 
   <li><a class="externalLink" href="http://www.academia.edu/4903777/Object-Oriented_Software_Construction_SECOND_EDITION">Object-Oriented Software Construction, Chapter 11, Design by Contract</a>.</li> 
   <li>The Pragmatic Programmer, Chapter 4, Design by Contract &amp; Assertive Programming.</li> 
   <li>Google.</li> 
  </ul> 
 </div> 
</div>
			</div>
		</div>
		<div class="span4">
			<div id="toc-sidebar">
				<div class="well">
					<ul class="nav nav-list">
						<li class="nav-header">Table of Contents</li>
		<li><a href="#in-depth" title="In-depth">In-depth</a>
		<li class="dropdown"><a href="#concepts" title="Concepts">Concepts <b class="caret"></b></a>
			<ul class="nav nav-list">
		<li><a href="#Programming_errors" title="Programming errors">Programming errors</a>
		<li><a href="#Recoverable_exceptions" title="Recoverable exceptions">Recoverable exceptions</a>
				<li class="divider"></li>
			</ul>
		</li>
		<li><a href="#defensive_programming_dont_do_it" title="Defensive programming, don’t do it">Defensive programming, don’t do it</a>
		<li class="dropdown"><a href="#programming_by_contracts" title="Programming by contracts">Programming by contracts <b class="caret"></b></a>
			<ul class="nav nav-list">
		<li><a href="#Require_contracts_preconditions" title="Require contracts (preconditions)">Require contracts (preconditions)</a>
		<li><a href="#Ensure_contracts_postconditions" title="Ensure contracts (postconditions)">Ensure contracts (postconditions)</a>
		<li><a href="#Invariants" title="Invariants">Invariants</a>
				<li class="divider"></li>
			</ul>
		</li>
		<li><a href="#assertive_programming" title="Assertive programming">Assertive programming</a>
		<li class="dropdown"><a href="#good_manners_to_keep" title="Good manners to keep">Good manners to keep <b class="caret"></b></a>
			<ul class="nav nav-list">
		<li><a href="#Separate_queries_from_commands" title="Separate queries from commands">Separate queries from commands</a>
		<li><a href="#Provide_a_complete_and_usable_interface_for_clients" title="Provide a complete (and usable) interface for clients">Provide a complete (and usable) interface for clients</a>
				<li class="divider"></li>
			</ul>
		</li>
		<li><a href="#contracts_vs_error_handling" title="Contracts vs. error handling">Contracts vs. error handling</a>
		<li><a href="#contracts_and_inheritance" title="Contracts and inheritance">Contracts and inheritance</a>
		<li><a href="#contracts_and_multi-threading" title="Contracts and multi-threading">Contracts and multi-threading</a>
		<li><a href="#contracts_and_unit_testing" title="Contracts and unit testing">Contracts and unit testing</a>
		<li><a href="#references" title="References">References</a>
					</ul>
				</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span1 bottom-nav">
					<ul class="nav nav-list">
					</ul>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014 <a href="http://valid4j.org">Valid4J</a>. All Rights Reserved.</p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src="./js/lightbox.js"></script>
	<script src="./js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="./js/jquery.ba-bbq.min.js"></script>

	<script src="./js/reflow-skin.js"></script>
	
	</body>
</html>
